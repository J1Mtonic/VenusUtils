<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="author" content="0xJ1M">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>LiquidationPanel</title>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://mottie.github.io/tablesorter/css/theme.blue.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tablesorter@latest/dist/js/jquery.tablesorter.combined.min.js"></script>
    <style>
        body,
        h1,
        h2,
        h3,
        h4,
        h5 {
            font-family: "Roboto", sans-serif;
            font-size: 9pt;
        }

        .tblLiquidations {
            width: auto;
        }

        tr:hover {
            cursor: pointer;
        }
    </style>

    <script type="text/javascript">
        const vTokens = [
            {
                "contract": "0x26DA28954763B92139ED49283625ceCAf52C6f94",
                "name": "vAAVE",
                "underlyingDecimals": "18"
            },
            {
                "contract": "0x9A0AF7FDb2065Ce470D72664DE73cAE409dA28Ec",
                "name": "vADA",
                "underlyingDecimals": "18"
            },
            {
                "contract": "0x5F0388EBc2B94FA8E123F404b79cCF5f40b29176",
                "name": "vBCH",
                "underlyingDecimals": "18"
            },
            {
                "contract": "0x972207A639CC1B374B893cc33Fa251b55CEB7c07",
                "name": "vBETH",
                "underlyingDecimals": "18"
            },
            {
                "contract": "0xA07c5b74C9B40447a954e1466938b865b6BBea36",
                "name": "vBNB",
                "underlyingDecimals": "18"
            },
            {
                "contract": "0x882C173bC7Ff3b7786CA16dfeD3DFFfb9Ee7847B",
                "name": "vBTCB",
                "underlyingDecimals": "18"
            },
            {
                "contract": "0x95c78222B3D6e262426483D42CfA53685A67Ab9D",
                "name": "vBUSD",
                "underlyingDecimals": "18"
            },
            {
                "contract": "0x86aC3974e2BD0d60825230fa6F355fF11409df5c",
                "name": "vCAKE",
                "underlyingDecimals": "18"
            },
            {
                "contract": "0x334b3eCB4DCa3593BCCC3c7EBD1A1C1d1780FBF1",
                "name": "vDAI",
                "underlyingDecimals": "18"
            },
            {
                "contract": "0xec3422Ef92B2fb59e84c8B02Ba73F1fE84Ed8D71",
                "name": "vDOGE",
                "underlyingDecimals": "8"
            },
            {
                "contract": "0x1610bc33319e9398de5f57B33a5b184c806aD217",
                "name": "vDOT",
                "underlyingDecimals": "18"
            },
            {
                "contract": "0xf508fCD89b8bd15579dc79A6827cB4686A3592c8",
                "name": "vETH",
                "underlyingDecimals": "18"
            },
            {
                "contract": "0xf91d58b5aE142DAcC749f58A49FCBac340Cb0343",
                "name": "vFIL",
                "underlyingDecimals": "18"
            },
            {
                "contract": "0x650b940a1033B8A1b1873f78730FcFC73ec11f1f",
                "name": "vLINK",
                "underlyingDecimals": "18"
            },
            {
                "contract": "0x57A5297F2cB2c0AaC9D554660acd6D385Ab50c6B",
                "name": "vLTC",
                "underlyingDecimals": "18"
            },
            {
                "contract": "0xb91A659E88B51474767CD97EF3196A3e7cEDD2c8",
                "name": "vLUNA",
                "underlyingDecimals": "18"
            },
            {
                "contract": "0x5c9476fcd6a4f9a3654139721c949c2233bbbbc8",
                "name": "vMATIC",
                "underlyingDecimals": "18"
            },
            {
                "contract": "0x2fF3d0F6990a40261c66E1ff2017aCBc282EB6d0",
                "name": "vSXP",
                "underlyingDecimals": "18"
            },
            {
                "contract": "0xc5d3466aa484b040ee977073fcf337f2c00071c1",
                "name": "vTRX",
                "underlyingDecimals": "18"
            },
            {
                "contract": "0x61eDcFe8Dd6bA3c891CB9bEc2dc7657B3B422E93",
                "name": "vTRXOLD",
                "underlyingDecimals": "18"
            },
            {
                "contract": "0x08ceb3f4a7ed3500ca0982bcd0fc7816688084c3",
                "name": "vTUSD",
                "underlyingDecimals": "18"
            },
            {
                "contract": "0xecA88125a5ADbe82614ffC12D0DB554E2e2867C8",
                "name": "vUSDC",
                "underlyingDecimals": "18"
            },
            {
                "contract": "0xfD5840Cd36d94D7229439859C0112a4185BC0255",
                "name": "vUSDT",
                "underlyingDecimals": "18"
            },
            {
                "contract": "0x78366446547D062f45b4C0f320cDaa6d710D87bb",
                "name": "vUST",
                "underlyingDecimals": "18"
            },
            {
                "contract": "0xB248a295732e0225acd3337607cc01068e3b9c10",
                "name": "vXRP",
                "underlyingDecimals": "18"
            },
            {
                "contract": "0x151B1e2635A717bcDc836ECd6FbB62B674FE3E1D",
                "name": "vXVS",
                "underlyingDecimals": "18"
            }
        ];

        window.addEventListener('load', loadLiquidationsFromGithub);

        async function loadLiquidationsFromGithub() {
            const response = await fetch('https://raw.githubusercontent.com/J1Mtonic/VenusUtils/main/data.json');
            const liquidations = await response.json();
            displayLiquidations(liquidations);
        }

        function displayLiquidations(liquidations) {
            const searchInput = document.getElementById('borrowerSearch');
            const table = document.querySelector('#tblLiquidations');
            const tableBody = table.querySelector('tbody');
            const tableHead = table.querySelector('thead');
            table.style.display = 'table';
            tableHead.style.display = 'table-header-group';
            liquidations.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="display: none">${item.transactionHash}</td>
                    <td style="display: none">${item.blockNumber}</td>
                    <td style="display: none">${item.timestamp}</td>
                    <td>${item.time}</td>
                    <td>${item.seizedTokens}</td>
                    <td>${item.repaidAmount}</td>
                    <td>${item.borrower}</td>
                `;

                row.addEventListener('click', () => {
                    window.open(`https://bscscan.com/tx/${item.transactionHash}`, '_blank');
                });

                tableBody.appendChild(row);
            });

            $("#tblLiquidations").tablesorter({ theme: 'blue' });
            var sorting = [[2, 1]];
            $("#tblLiquidations").trigger("sorton", [sorting]).trigger("update");

            searchInput.addEventListener('input', filterTableRows);
            searchInput.disabled = false;
        }

        function filterTableRows() {
            const searchInput = document.getElementById('borrowerSearch');
            const table = document.querySelector('#tblLiquidations');
            const tableBody = table.querySelector('tbody');
            const rows = tableBody.querySelectorAll('tr');

            rows.forEach(row => {
                const borrowerCellText = row.children[6].textContent.toUpperCase();
                if (!borrowerCellText.includes(searchInput.value.toUpperCase())) {
                    row.style.display = 'none';
                } else {
                    row.style.display = '';
                }
            });
        }

        async function searchLiquidations() {
            const searchButton = document.getElementById('searchButton');
            const searchInput = document.getElementById('borrowerSearch');
            //const searchDirectionSelector = document.getElementById('searchDirection');
            const searchDirection = "up"; // searchDirectionSelector.value;
            const provider = new Web3.providers.HttpProvider("https://bscrpc.com");
            const getBep20Abi = "https://api.bscscan.com/api?module=contract&action=getabi&address=";
            const bscscanAPI = "&apikey=J5HERDUSE8HWU7HISSURZY1349VBWHX31F";
            const web3 = new Web3(provider);
            searchButton.disabled = true;
            //downloadButton.disabled = true;
            searchInput.disabled = false;

            let vTokenAbi = await fetch(getBep20Abi + vTokens[0].contract + bscscanAPI)
                .then(response => response.json())
                .then(data => {
                    return JSON.parse(data.result);
                });

            async function getBlockTimeStamp(blockNumber) {
                const block = await web3.eth.getBlock(blockNumber);
                return block.timestamp;
            }

            async function generateEventQuery(vToken, events) {
                const table = document.querySelector('#tblLiquidations');
                const tableBody = table.querySelector('tbody');
                const tableHead = table.querySelector('thead');

                if (events.length > 0 && table.style.display === 'none') {
                    table.style.display = 'table';
                    tableHead.style.display = 'table-header-group';
                }
                for (const event of events) {
                    const timestamp = await getBlockTimeStamp(event.blockNumber);
                    const date = new Date(timestamp * 1000);

                    const provider = new Web3.providers.HttpProvider('https://bsc-dataseed.binance.org');
                    const web3 = new Web3(provider);
                    const vTokenDecimals = 8;
                    const vTokenCollateral = vTokens.find(vToken => vToken.contract.toLowerCase() === event.returnValues.vTokenCollateral.toLowerCase());
                    const vTokenCall = new web3.eth.Contract(vTokenAbi, event.returnValues.vTokenCollateral);
                    const exRate = Math.pow(10, 18 + Number(vTokenCollateral.underlyingDecimals) - vTokenDecimals) / await vTokenCall.methods.exchangeRateCurrent().call();
                    const UnderlyingSeizedTokens = ((event.returnValues.seizeTokens / exRate) / Math.pow(10, vTokenDecimals)).toFixed(4);
                    const repaidAmount = (event.returnValues.repayAmount / Math.pow(10, Number(vToken.underlyingDecimals))).toFixed(4);

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="display: none">${event.transactionHash}</td>
                        <td style="display: none">${event.blockNumber}</td>
                        <td style="display: none">${timestamp}</td>
                        <td>${date.toISOString().slice(0, 19).replace('T', ' ')}</td>
                        <td>${UnderlyingSeizedTokens + " " + vTokenCollateral.name.slice(1)}</td>
                        <td>${repaidAmount + " " + vToken.name.slice(1)}</td>
                        <td>${event.returnValues.borrower}</td>
                    `;

                    row.addEventListener('click', () => {
                        window.open(`https://bscscan.com/tx/${event.transactionHash}`, '_blank');
                    });

                    if (searchDirection === 'up') {
                        tableBody.insertBefore(row, tableBody.firstChild);
                    } else if (searchDirection === 'down') {
                        tableBody.appendChild(row);
                    }
                }
                $("#tblLiquidations").tablesorter({ theme: 'blue' });
                var sorting = [[2, 1]];
                $("#tblLiquidations").trigger("sorton", [sorting]).trigger("update");
            }

            searchInput.addEventListener('input', () => {
                const rows = document.querySelector('#tblLiquidations tbody').rows;

                for (let i = 0; i < rows.length; i++) {
                    const borrowerCellText = rows[i].children[3].textContent.toUpperCase();
                    if (!borrowerCellText.includes(searchInput.value.toUpperCase())) {
                        rows[i].style.display = 'none';
                    } else {
                        rows[i].style.display = '';
                    }
                }
            });

            try {                
                let period = 2400; //2H (3s/Block)
                if (searchDirection === 'up') {
                    let fromBlock = Number(document.querySelector('#tblLiquidations tbody').firstElementChild.children[1].textContent) + 1;
                    let toBlock = await web3.eth.getBlockNumber();
                    const blockDifference = toBlock - fromBlock;                    

                    for (let i = 0; i < Math.ceil(blockDifference / period); i++) {
                        const currentFromBlock = fromBlock + (i * period);
                        const currentToBlock = Math.min(fromBlock + ((i + 1) * period), toBlock);

                        for (let vToken of vTokens) {
                            const myContract = new web3.eth.Contract(vTokenAbi, vToken.contract);
                            let events = await myContract.getPastEvents('LiquidateBorrow', {
                                fromBlock: currentFromBlock,
                                toBlock: currentToBlock
                            });
                            await generateEventQuery(vToken, events);
                        }
                    }
                } else if (searchDirection === 'down') {
                    let toBlock = Number(document.querySelector('#tblLiquidations tbody').lastElementChild.children[1].textContent) - 1;
                    let days = 12 * (Number(document.getElementById('daysToFetch').value) || 1);
                    for (let i = 0; i < days; i++) {
                        for (let vToken of vTokens) {
                            const myContract = new web3.eth.Contract(vTokenAbi, vToken.contract);
                            let fromBlock = toBlock - period;  
                            let events = await myContract.getPastEvents('LiquidateBorrow', {
                                fromBlock: fromBlock,
                                toBlock: toBlock
                            });
                            await generateEventQuery(vToken, events);
                        }
                        toBlock -= period + 1;
                    }
                }
            } catch (err) {
                console.log("Error:", err);
            } finally {
                searchButton.disabled = false;
                //downloadButton.disabled = false;
            }
        }

        function downloadJSON() {
            const table = document.querySelector('#tblLiquidations');
            const rows = Array.from(table.querySelector('tbody').rows);
            const data = rows.map(row => {
                const cells = Array.from(row.children);
                return {
                    transactionHash: cells[0].textContent,
                    blockNumber: cells[1].textContent,
                    timestamp: cells[2].textContent,
                    time: cells[3].textContent,
                    seizedTokens: cells[4].textContent,
                    repaidAmount: cells[5].textContent,
                    borrower: cells[6].textContent
                };
            });
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'data.json';
            link.click();
            URL.revokeObjectURL(url);
        }
    </script>
</head>

<body>
    <input type="text" id="borrowerSearch" placeholder="Search for Borrower..." disabled>
    <div id="eventData">
        <table id="tblLiquidations" class="tblLiquidations tablesorter" style="display: none;">
            <thead style="display: none;">
                <th class="sorter-false">TimeStamp</th>
                <th class="sorter-false">SeizedTokens</th>
                <th class="sorter-false">RepaidAmount</th>
                <th class="sorter-false">Borrower</th>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</body>

</html>